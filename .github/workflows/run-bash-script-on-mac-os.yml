name: Run Bash Script on Mac OS
on: [push]
jobs:
  Run-Script:
    runs-on: macos-12
    steps:
    ## Try to run your bash script in the macos-12 environment
      ## WORKS: Clone your repository code (including the bash script) onto the runner
      # - uses: actions/checkout@v3
      ## WORKS: Try to run the bash script inside of the runner
      # - name: Run bash script
      #   run: ./set-up-laptop.sh
      ## CONFIRMED: Homebrew is already installed inside the runner:
      # - name: Check if Homebrew comes pre-installed on GitHub Actions MacOS Virtual Machine
      #   run: brew help
      ## Uninstall Homebrew (pre-installed on GitHub Actions MacOS Virtual Machine):
      ## - Doesn't fail, but doesn't remove everything it should due to not having sudo permissions
      # - name: Uninstall pre-installed Homebrew version
        # run: NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"
      - name: Uninstall pre-installed Homebrew version
        run: |
          curl -sLO https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh
          chmod +x ./uninstall.sh
          sudo ./uninstall.sh --force
      - name: Remove remaining pre-installed Homebrew directories that weren't removed
        # We were told these files possibly related to Homebrew haven't been deleted, so we should remove them:
        run: |
          sudo rm -rf /usr/local/.com.apple.installer.keep
          sudo rm -rf /usr/local/Frameworks/
          sudo rm -rf /usr/local/Homebrew/
          sudo rm -rf /usr/local/aws-cli/
          sudo rm -rf /usr/local/bin/
          sudo rm -rf /usr/local/etc/
          sudo rm -rf /usr/local/include/
          sudo rm -rf /usr/local/lib/
          sudo rm -rf /usr/local/microsoft/
          sudo rm -rf /usr/local/miniconda/
          sudo rm -rf /usr/local/opt/
          sudo rm -rf /usr/local/sbin/
          sudo rm -rf /usr/local/sessionmanagerplugin/
          sudo rm -rf /usr/local/share/
          sudo rm -rf /usr/local/var/
      - name: Ensure reportedly deleted pre-installed Homebrew directories no longer exist
        # We were told these would be deleted, but good to ensure that they are definitely deleted:
        run: |
          sudo rm -rf /usr/local/Caskroom
          sudo rm -rf /usr/local/bin/brew
      # CONFIRMED: Fails correctly as Homebrew at this point had been correctly uninstalled and was no longer available
      # - name: Check pre-installed Homebrew version has been removed
        # Check output to see whether this looks successful or not
        # run: brew help
      - name: Ensure pre-installed Homebrew version has been removed
        run: |
          if ! command -v brew &> /dev/null
            then echo 'Homebrew is still installed but it should have been removed. Uninstall Homebrew before installing fresh version of Homebrew.'
            exit 1
          fi
      - name: Install a fresh version of Homebrew
        # Taken from Homebrew docs: 
        # https://github.com/Homebrew/install/#install-homebrew-on-macos-or-linux:~:text=If%20you%20want%20to%20run%20the%20Homebrew%20installer%20non%2Dinteractively%20without%20prompting%20for%20passwords%20(e.g.%20in%20automation%20scripts)%2C%20you%20can%20use
        run: NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      - name: Check fresh Homebrew version is installed in the MacOS Virtual Machine's PATH
        run: brew help
